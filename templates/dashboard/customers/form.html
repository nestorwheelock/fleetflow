{% extends 'base.html' %}

{% block title %}{% if object %}Edit{% else %}Add{% endif %} Customer - FleetFlow{% endblock %}

{% block content %}
<div x-data="customerForm()" class="mb-8">
    <a href="/dashboard/customers/" class="text-blue-600 hover:underline">&larr; Back to Customers</a>
    <h1 class="text-3xl font-bold text-gray-900 mt-2">{% if object %}Edit Customer{% else %}Add New Customer{% endif %}</h1>
</div>

<div x-data="customerForm()" class="bg-white rounded-lg shadow p-6 max-w-4xl">
    <form method="post" enctype="multipart/form-data" class="space-y-6">
        {% csrf_token %}

        {% if form.errors %}
        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
            <p class="font-bold">Please correct the errors below:</p>
            {{ form.non_field_errors }}
        </div>
        {% endif %}

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <label for="id_first_name" class="block text-sm font-medium text-gray-700 mb-1">First Name *</label>
                <input type="text" name="first_name" id="id_first_name" value="{{ form.first_name.value|default:'' }}" required
                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                {% if form.first_name.errors %}<p class="text-red-600 text-sm mt-1">{{ form.first_name.errors.0 }}</p>{% endif %}
            </div>

            <div>
                <label for="id_last_name" class="block text-sm font-medium text-gray-700 mb-1">Last Name *</label>
                <input type="text" name="last_name" id="id_last_name" value="{{ form.last_name.value|default:'' }}" required
                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                {% if form.last_name.errors %}<p class="text-red-600 text-sm mt-1">{{ form.last_name.errors.0 }}</p>{% endif %}
            </div>

            <div>
                <label for="id_email" class="block text-sm font-medium text-gray-700 mb-1">Email *</label>
                <input type="email" name="email" id="id_email" value="{{ form.email.value|default:'' }}" required
                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                {% if form.email.errors %}<p class="text-red-600 text-sm mt-1">{{ form.email.errors.0 }}</p>{% endif %}
            </div>

            <div>
                <label for="id_phone" class="block text-sm font-medium text-gray-700 mb-1">Phone</label>
                <input type="text" name="phone" id="id_phone" value="{{ form.phone.value|default:'' }}"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                {% if form.phone.errors %}<p class="text-red-600 text-sm mt-1">{{ form.phone.errors.0 }}</p>{% endif %}
            </div>
        </div>

        <hr class="my-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4">Address</h3>

        <div class="space-y-4">
            <div>
                <label for="id_address" class="block text-sm font-medium text-gray-700 mb-1">Street Address</label>
                <input type="text" name="address" id="id_address" value="{{ form.address.value|default:'' }}"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label for="id_city" class="block text-sm font-medium text-gray-700 mb-1">City</label>
                    <input type="text" name="city" id="id_city" value="{{ form.city.value|default:'' }}"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="id_state" class="block text-sm font-medium text-gray-700 mb-1">State</label>
                    <input type="text" name="state" id="id_state" value="{{ form.state.value|default:'' }}"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="id_zip_code" class="block text-sm font-medium text-gray-700 mb-1">Zip Code</label>
                    <input type="text" name="zip_code" id="id_zip_code" value="{{ form.zip_code.value|default:'' }}"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>
        </div>

        <hr class="my-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-medium text-gray-900">Driver's License</h3>
            {% if can_use_ocr %}
            <button type="button" @click="parseLicense()" :disabled="parsing || !hasLicenseImage()"
                class="inline-flex items-center px-3 py-1.5 border border-blue-600 text-sm font-medium rounded-md text-blue-600 bg-white hover:bg-blue-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed">
                <svg x-show="!parsing" class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                </svg>
                <svg x-show="parsing" class="animate-spin w-4 h-4 mr-1.5" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span x-text="parsing ? 'Parsing...' : 'Parse License'"></span>
            </button>
            {% endif %}
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
                <label for="id_license_number" class="block text-sm font-medium text-gray-700 mb-1">License Number</label>
                <input type="text" name="license_number" id="id_license_number" value="{{ form.license_number.value|default:'' }}"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div>
                <label for="id_license_state" class="block text-sm font-medium text-gray-700 mb-1">License State</label>
                <input type="text" name="license_state" id="id_license_state" value="{{ form.license_state.value|default:'' }}"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div>
                <label for="id_license_expiry" class="block text-sm font-medium text-gray-700 mb-1">License Expiry</label>
                <input type="date" name="license_expiry" id="id_license_expiry" value="{{ form.license_expiry.value|default:'' }}"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
            <div>
                <label for="id_license_image_front" class="block text-sm font-medium text-gray-700 mb-1">License Front Image</label>
                {% if object.license_image_front %}
                <div class="mb-2">
                    <img src="{{ object.license_image_front.url }}" alt="License Front" class="max-w-xs h-auto rounded border">
                    <p class="text-sm text-gray-500 mt-1">Current image - upload new to replace</p>
                </div>
                {% endif %}
                <input type="file" name="license_image_front" id="id_license_image_front" accept="image/*"
                    @change="onLicenseImageChange($event)"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                {% if form.license_image_front.errors %}<p class="text-red-600 text-sm mt-1">{{ form.license_image_front.errors.0 }}</p>{% endif %}
            </div>
            <div>
                <label for="id_license_image_back" class="block text-sm font-medium text-gray-700 mb-1">License Back Image</label>
                {% if object.license_image_back %}
                <div class="mb-2">
                    <img src="{{ object.license_image_back.url }}" alt="License Back" class="max-w-xs h-auto rounded border">
                    <p class="text-sm text-gray-500 mt-1">Current image - upload new to replace</p>
                </div>
                {% endif %}
                <input type="file" name="license_image_back" id="id_license_image_back" accept="image/*"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                {% if form.license_image_back.errors %}<p class="text-red-600 text-sm mt-1">{{ form.license_image_back.errors.0 }}</p>{% endif %}
            </div>
        </div>

        <div class="flex justify-end space-x-4 pt-6">
            <a href="/dashboard/customers/" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                Cancel
            </a>
            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                {% if object %}Update Customer{% else %}Create Customer{% endif %}
            </button>
        </div>
    </form>

    <!-- OCR Review Modal -->
    <div x-show="showOCRModal" x-cloak class="fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div x-show="showOCRModal" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
                class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" @click="showOCRModal = false"></div>

            <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>

            <div x-show="showOCRModal" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
                class="inline-block align-bottom bg-white rounded-lg px-4 pt-5 pb-4 text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl sm:w-full sm:p-6">

                <div class="sm:flex sm:items-start">
                    <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 sm:mx-0 sm:h-10 sm:w-10">
                        <svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left flex-grow">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                            License Data Extracted
                        </h3>
                        <p class="mt-1 text-sm text-gray-500">
                            Confidence: <span class="font-medium" :class="ocrData.confidence >= 0.8 ? 'text-green-600' : 'text-yellow-600'" x-text="(ocrData.confidence * 100).toFixed(0) + '%'"></span>
                        </p>
                    </div>
                </div>

                <div class="mt-4 border-t border-gray-200 pt-4">
                    <p class="text-sm text-gray-600 mb-3">Select fields to apply (only empty fields will be updated):</p>

                    <div class="grid grid-cols-2 gap-3 max-h-80 overflow-y-auto">
                        <template x-for="field in ocrFields" :key="field.key">
                            <label class="flex items-start space-x-3 p-2 rounded hover:bg-gray-50" :class="field.value ? '' : 'opacity-50'">
                                <input type="checkbox" x-model="selectedFields" :value="field.key" :disabled="!field.value"
                                    class="mt-0.5 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                <div class="flex-grow min-w-0">
                                    <span class="block text-sm font-medium text-gray-700" x-text="field.label"></span>
                                    <span class="block text-sm text-gray-500 truncate" x-text="field.value || '(empty)'"></span>
                                </div>
                            </label>
                        </template>
                    </div>
                </div>

                <div class="mt-5 sm:mt-4 sm:flex sm:flex-row-reverse">
                    <button type="button" @click="applySelectedFields()"
                        :disabled="selectedFields.length === 0"
                        class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm disabled:opacity-50 disabled:cursor-not-allowed">
                        Apply Selected (<span x-text="selectedFields.length"></span>)
                    </button>
                    <button type="button" @click="showOCRModal = false"
                        class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:w-auto sm:text-sm">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div x-show="toast.show" x-cloak
        x-transition:enter="transform ease-out duration-300 transition"
        x-transition:enter-start="translate-y-2 opacity-0 sm:translate-y-0 sm:translate-x-2"
        x-transition:enter-end="translate-y-0 opacity-100 sm:translate-x-0"
        x-transition:leave="transition ease-in duration-100"
        x-transition:leave-start="opacity-100"
        x-transition:leave-end="opacity-0"
        class="fixed bottom-4 right-4 max-w-sm w-full bg-white shadow-lg rounded-lg pointer-events-auto ring-1 ring-black ring-opacity-5">
        <div class="p-4">
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    <svg x-show="toast.type === 'success'" class="h-6 w-6 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <svg x-show="toast.type === 'error'" class="h-6 w-6 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
                <div class="ml-3 w-0 flex-1">
                    <p class="text-sm font-medium text-gray-900" x-text="toast.message"></p>
                </div>
            </div>
        </div>
    </div>
</div>

{% if can_use_ocr %}
<script>
function customerForm() {
    return {
        parsing: false,
        showOCRModal: false,
        ocrData: {},
        ocrFields: [],
        selectedFields: [],
        licenseImageFile: null,
        toast: { show: false, message: '', type: 'success' },

        hasExistingImage: {{ object.license_image_front|yesno:'true,false' }},

        hasLicenseImage() {
            return this.licenseImageFile !== null || this.hasExistingImage;
        },

        onLicenseImageChange(event) {
            const file = event.target.files[0];
            if (file) {
                this.licenseImageFile = file;
            }
        },

        async parseLicense() {
            this.parsing = true;

            try {
                const formData = new FormData();
                if (this.licenseImageFile) {
                    formData.append('image', this.licenseImageFile);
                }

                const url = {% if object %}'/api/automation/parse-license/{{ object.pk }}/'{% else %}'/api/automation/parse-license/'{% endif %};
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': this.getCSRFToken()
                    },
                    body: formData
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    this.ocrData = data.data;
                    this.prepareOCRFields();
                    this.showOCRModal = true;
                } else {
                    this.showToast(data.error || 'Failed to parse license', 'error');
                }
            } catch (error) {
                this.showToast('Error parsing license: ' + error.message, 'error');
            } finally {
                this.parsing = false;
            }
        },

        prepareOCRFields() {
            const fieldMap = {
                'first_name': 'First Name',
                'middle_name': 'Middle Name',
                'last_name': 'Last Name',
                'license_number': 'License Number',
                'issuing_authority': 'License State',
                'expiration_date': 'License Expiry',
                'date_of_birth': 'Date of Birth',
                'address_street': 'Street Address',
                'address_city': 'City',
                'address_state': 'State',
                'address_zip': 'Zip Code',
                'gender': 'Gender',
                'height': 'Height',
                'weight': 'Weight',
                'eye_color': 'Eye Color',
                'hair_color': 'Hair Color',
            };

            this.ocrFields = Object.entries(fieldMap).map(([key, label]) => ({
                key,
                label,
                value: this.ocrData[key] || ''
            }));

            this.selectedFields = this.ocrFields
                .filter(f => f.value)
                .map(f => f.key);
        },

        applySelectedFields() {
            const formFieldMap = {
                'first_name': 'id_first_name',
                'middle_name': 'id_middle_name',
                'last_name': 'id_last_name',
                'license_number': 'id_license_number',
                'issuing_authority': 'id_license_state',
                'expiration_date': 'id_license_expiry',
                'address_street': 'id_address',
                'address_city': 'id_city',
                'address_state': 'id_state',
                'address_zip': 'id_zip_code',
            };

            let applied = 0;
            let skipped = 0;

            for (const fieldKey of this.selectedFields) {
                const formFieldId = formFieldMap[fieldKey];
                if (!formFieldId) continue;

                const input = document.getElementById(formFieldId);
                if (!input) continue;

                if (input.value && input.value.trim() !== '') {
                    skipped++;
                    continue;
                }

                const value = this.ocrData[fieldKey];
                if (value) {
                    input.value = value;
                    applied++;
                }
            }

            this.showOCRModal = false;
            this.showToast(`Applied ${applied} field(s)${skipped > 0 ? `, skipped ${skipped} (already filled)` : ''}`, 'success');
        },

        showToast(message, type) {
            this.toast = { show: true, message, type };
            setTimeout(() => this.toast.show = false, 5000);
        },

        getCSRFToken() {
            const name = 'csrftoken';
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [cookieName, cookieValue] = cookie.trim().split('=');
                if (cookieName === name) {
                    return cookieValue;
                }
            }
            return '';
        }
    };
}
</script>
{% endif %}
{% endblock %}
